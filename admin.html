<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - Solera Cask</title>
    <link rel="stylesheet" href="css/styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@300;400;500;600;700&family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
    <style>
        /* Admin-specific styles matching Solera's aesthetic */
        .admin-container {
            min-height: 100vh;
            background: var(--warm-white);
            font-family: 'Inter', sans-serif;
        }

        .login-container {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
        }

        .login-form {
            background: var(--warm-white);
            padding: 60px;
            max-width: 400px;
            width: 100%;
            text-align: center;
            box-shadow: var(--shadow-strong);
        }

        .login-form h2 {
            font-family: 'Playfair Display', serif;
            font-size: 32px;
            color: var(--text-primary);
            margin-bottom: 40px;
            font-weight: 400;
        }

        .admin-nav {
            background: var(--text-primary);
            color: var(--text-white);
            padding: 0;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .nav-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px 40px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .nav-container .logo {
            font-family: 'Playfair Display', serif;
            font-size: 24px;
            font-weight: 600;
            color: var(--accent-gold);
            text-decoration: none;
        }

        .admin-user {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .logout-btn {
            background: transparent;
            color: var(--text-white);
            border: 1px solid var(--accent-gold);
            padding: 8px 16px;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .logout-btn:hover {
            background: var(--accent-gold);
            color: var(--text-primary);
        }

        .admin-content {
            display: flex;
            min-height: calc(100vh - 80px);
        }

        .admin-sidebar {
            width: 280px;
            background: var(--cream);
            border-right: 1px solid var(--border);
            padding: 40px 0;
        }

        .admin-menu {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .admin-menu li {
            margin: 0;
        }

        .admin-menu a {
            display: block;
            padding: 16px 40px;
            color: var(--text-secondary);
            text-decoration: none;
            font-size: 15px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            transition: all 0.3s ease;
            border-left: 3px solid transparent;
        }

        .admin-menu a:hover,
        .admin-menu a.active {
            background: var(--warm-white);
            color: var(--primary);
            border-left-color: var(--primary);
        }

        .admin-main {
            flex: 1;
            padding: 40px;
            overflow-y: auto;
        }

        .admin-section {
            display: none;
        }

        .admin-section.active {
            display: block;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }

        .stat-card {
            background: var(--warm-white);
            border: 1px solid var(--border-light);
            padding: 24px;
            text-align: center;
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-medium);
        }

        .stat-number {
            font-family: 'Playfair Display', serif;
            font-size: 36px;
            font-weight: 600;
            color: var(--primary);
            margin-bottom: 8px;
        }

        .stat-label {
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: var(--text-secondary);
            font-weight: 600;
        }

        .posts-table-container {
            background: var(--warm-white);
            border: 1px solid var(--border-light);
            overflow-x: auto;
        }

        .posts-table {
            width: 100%;
            border-collapse: collapse;
        }

        .posts-table th {
            background: var(--cream);
            padding: 20px;
            text-align: left;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: var(--text-primary);
            font-weight: 600;
            border-bottom: 1px solid var(--border);
        }

        .posts-table td {
            padding: 20px;
            border-bottom: 1px solid var(--border-light);
            vertical-align: top;
        }

        .post-title-main {
            font-weight: 500;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .post-meta-small {
            font-size: 12px;
            color: var(--text-light);
        }

        .post-type-badge {
            background: var(--primary);
            color: var(--text-white);
            padding: 4px 8px;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            font-weight: 500;
        }

        .status-badge {
            padding: 4px 8px;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            font-weight: 500;
        }

        .status-published {
            background: rgba(6, 255, 165, 0.1);
            color: #06ffa5;
        }

        .status-draft {
            background: rgba(255, 184, 0, 0.1);
            color: #ffb800;
        }

        .status-featured {
            background: rgba(160, 82, 45, 0.1);
            color: var(--primary);
        }

        .featured-indicator {
            background: var(--accent-gold);
            color: var(--text-primary);
            padding: 2px 6px;
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            font-weight: 600;
            margin-left: 8px;
            border-radius: 2px;
        }


        .action-btn[title="Toggle Featured"] {
            font-size: 16px;
            color: #ffd700;
        }

        .action-btn[title="Toggle Featured"]:hover {
            transform: scale(1.2);
            color: #ffed4e;
        }

        .action-buttons {
            display: flex;
            gap: 8px;
        }

        .action-btn {
            background: transparent;
            border: 1px solid var(--border);
            padding: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .action-btn:hover {
            background: var(--primary);
            border-color: var(--primary);
            color: var(--text-white);
        }

        .post-form {
            background: var(--warm-white);
            border: 1px solid var(--border-light);
            padding: 40px;
        }


        /* Featured post upload section */
        #featuredImageUpload {
            background: rgba(255, 215, 0, 0.1);
            border: 1px dashed #ffd700;
            padding: 15px;
            border-radius: 8px;
            margin-top: 10px;
        }

        #featuredImagePreview img {
            max-width: 200px;
            max-height: 150px;
            object-fit: cover;
            border-radius: 4px;
            margin-top: 10px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
            margin-bottom: 24px;
        }

        .form-group {
            margin-bottom: 24px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-primary);
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 16px 0;
            border: none;
            border-bottom: 1px solid var(--border);
            background: transparent;
            font-size: 16px;
            color: var(--text-primary);
            transition: border-color 0.3s ease;
            font-family: 'Inter', sans-serif;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-bottom-color: var(--primary);
            border-bottom-width: 2px;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 120px;
        }

        .content-format-toggle {
            margin-bottom: 16px;
        }

        .format-toggle-buttons {
            display: flex;
            gap: 0;
            border: 1px solid var(--border);
            border-radius: 4px;
            overflow: hidden;
        }

        .format-toggle-btn {
            background: var(--warm-white);
            border: none;
            padding: 12px 24px;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            cursor: pointer;
            transition: all 0.3s ease;
            border-right: 1px solid var(--border);
        }

        .format-toggle-btn:last-child {
            border-right: none;
        }

        .format-toggle-btn.active {
            background: var(--primary);
            color: var(--text-white);
        }

        .format-toggle-btn:hover:not(.active) {
            background: var(--cream);
        }

        .html-editor {
            background: var(--text-primary);
            color: #ffffff;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 14px;
            line-height: 1.6;
            padding: 20px;
            border-radius: 4px;
            resize: vertical;
            min-height: 300px;
            overflow-x: auto;
            white-space: pre;
            tab-size: 2;
        }

        .html-editor:focus {
            outline: 2px solid var(--primary);
            outline-offset: 2px;
        }

        .html-preview {
            border: 1px solid var(--border);
            background: var(--warm-white);
            padding: 20px;
            min-height: 300px;
            overflow-y: auto;
            max-height: 500px;
        }

        .preview-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--border-light);
        }

        .preview-title {
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-secondary);
            font-weight: 600;
        }

        .refresh-preview-btn {
            background: var(--primary);
            color: var(--text-white);
            border: none;
            padding: 6px 12px;
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .refresh-preview-btn:hover {
            background: var(--primary-dark);
        }

        .featured-controls {
            background: var(--cream);
            border: 1px solid var(--border);
            padding: 20px;
            margin-bottom: 24px;
            border-radius: 4px;
        }

        .featured-checkbox {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
        }

        .featured-checkbox input[type="checkbox"] {
            width: auto;
            transform: scale(1.2);
        }

        .featured-image-upload {
            margin-top: 16px;
        }

        .featured-image-preview {
            margin-top: 16px;
            max-width: 200px;
        }

        .featured-image-preview img {
            width: 100%;
            height: 120px;
            object-fit: cover;
            border-radius: 4px;
            border: 1px solid var(--border);
        }

        .form-actions {
            display: flex;
            gap: 16px;
            margin-top: 40px;
        }

        .btn-primary {
            background: var(--primary);
            color: var(--text-white);
            border: none;
            padding: 16px 32px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-primary:hover {
            background: var(--primary-light);
            color: var(--text-primary);
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: transparent;
            color: var(--text-primary);
            border: 1px solid var(--border);
            padding: 16px 32px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-secondary:hover {
            background: var(--text-primary);
            color: var(--text-white);
        }

        .form-section {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 24px;
            margin-bottom: 24px;
        }

        .section-title {
            font-size: 16px;
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 8px;
            border-bottom: 1px solid #e2e8f0;
            padding-bottom: 12px;
        }

        .section-icon {
            font-size: 18px;
        }

        .seo-section {
            background: #f0fff4;
            border-color: #9ae6b4;
        }

        .auto-seo-btn {
            background: #48bb78;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            margin-left: auto;
        }

        .auto-seo-btn:hover {
            background: #38a169;
        }

        .char-count {
            font-size: 12px;
            color: #6b7280;
            text-align: right;
            margin-top: 4px;
        }

        .char-count.warning {
            color: #f59e0b;
        }

        .char-count.error {
            color: #ef4444;
        }

        .help-text {
            font-size: 12px;
            color: #6b7280;
            margin-top: 4px;
        }

        .seo-preview {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            padding: 16px;
            margin-top: 16px;
        }

        .seo-preview h4 {
            margin-bottom: 12px;
            color: #2d3748;
            font-size: 14px;
        }

        .search-preview {
            font-family: arial, sans-serif;
        }

        .preview-title {
            color: #1a0dab;
            font-size: 18px;
            margin-bottom: 4px;
            text-decoration: underline;
            cursor: pointer;
        }

        .preview-url {
            color: #006621;
            font-size: 14px;
            margin-bottom: 8px;
        }

        .preview-description {
            color: #545454;
            font-size: 13px;
            line-height: 1.4;
        }

        .advanced-seo {
            margin-top: 20px;
            border-top: 1px solid #e2e8f0;
            padding-top: 20px;
        }

        .toggle-advanced {
            background: none;
            border: none;
            color: #4299e1;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            padding: 0;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .toggle-advanced:hover {
            color: #3182ce;
        }

        .advanced-seo-content {
            margin-top: 16px;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 12px;
        }

        .checkbox-group input[type="checkbox"] {
            width: auto;
        }

        .admin-message {
            position: fixed;
            top: 100px;
            right: 20px;
            padding: 16px 24px;
            max-width: 400px;
            z-index: 1000;
            font-weight: 500;
            animation: slideInRight 0.3s ease-out;
        }

        .admin-message-success {
            background: rgba(6, 255, 165, 0.1);
            border: 1px solid rgba(6, 255, 165, 0.3);
            color: #06ffa5;
        }

        .admin-message-error {
            background: rgba(255, 68, 68, 0.1);
            border: 1px solid rgba(255, 68, 68, 0.3);
            color: #ff4444;
        }

        .admin-message-info {
            background: rgba(160, 82, 45, 0.1);
            border: 1px solid rgba(160, 82, 45, 0.3);
            color: var(--primary);
        }

        .image-upload-container {
            margin-top: 16px;
        }

        .image-drop-zone {
            border: 2px dashed var(--border);
            padding: 40px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: var(--light-beige);
            position: relative;
        }

        .image-drop-zone:hover,
        .image-drop-zone.drag-over {
            border-color: var(--primary);
            background: rgba(160, 82, 45, 0.05);
        }

        .drop-zone-content svg {
            color: var(--text-light);
            margin-bottom: 16px;
        }

        .drop-zone-content p {
            color: var(--text-secondary);
            margin-bottom: 8px;
            font-size: 16px;
        }

        .browse-link {
            color: var(--primary);
            text-decoration: underline;
            cursor: pointer;
        }

        .drop-zone-content small {
            color: var(--text-light);
            font-size: 12px;
        }

        .uploaded-images {
            margin-top: 20px;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 16px;
        }

        .uploaded-image {
            position: relative;
            border: 1px solid var(--border-light);
            background: var(--warm-white);
            padding: 12px;
            border-radius: 4px;
        }

        .uploaded-image img {
            width: 100%;
            height: 120px;
            object-fit: cover;
            border-radius: 2px;
            margin-bottom: 8px;
        }

        .image-info {
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }

        .image-code {
            max-height: 60px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            background: #f5f5f5;
            padding: 8px;
            border-radius: 4px;
            cursor: pointer;
            border: 1px solid #ddd;
            word-break: break-all;
        }

        .image-code:hover {
            background: var(--light-beige);
        }

        .upload-progress {
            padding: 10px;
            text-align: center;
            font-style: italic;
            color: #666;
            background: #f9f9f9;
            border-radius: 4px;
        }

        .copy-tooltip {
            position: absolute;
            top: -30px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--text-primary);
            color: var(--text-white);
            padding: 4px 8px;
            font-size: 10px;
            border-radius: 2px;
            opacity: 0;
            transition: opacity 0.3s ease;
            pointer-events: none;
            white-space: nowrap;
        }

        .copy-tooltip.show {
            opacity: 1;
        }

        .image-actions {
            display: flex;
            gap: 8px;
        }

        .image-btn {
            background: var(--primary);
            color: var(--text-white);
            border: none;
            padding: 4px 8px;
            font-size: 10px;
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            transition: all 0.3s ease;
        }

        .image-btn:hover {
            background: var(--primary-dark);
        }

        .image-btn.danger {
            background: #ff4444;
        }

        .image-btn.danger:hover {
            background: #cc3333;
        }

        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid var(--border);
            border-radius: 50%;
            border-top-color: var(--primary);
            animation: spin 1s ease-in-out infinite;
        }

        .image-code {
            max-height: 60px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @media (max-width: 768px) {
            .admin-content {
                flex-direction: column;
            }

            .admin-sidebar {
                width: 100%;
                order: 2;
            }

            .admin-main {
                order: 1;
                padding: 20px;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .nav-container {
                padding: 20px;
            }

            .login-form {
                padding: 40px 20px;
                margin: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="admin-container">
        <!-- Login Form -->
        <div class="login-container" id="loginContainer">
            <div class="login-form">
                <h2>Solera Cask Admin</h2>
                <form id="loginForm">
                    <div class="form-group">
                        <label for="username">Username</label>
                        <input type="text" id="username" name="username" required>
                    </div>
                    <div class="form-group">
                        <label for="password">Password</label>
                        <input type="password" id="password" name="password" required>
                    </div>
                    <button type="submit" class="btn-primary">
                        <span class="btn-text">Login</span>
                        <span class="loading-spinner" style="display: none;"></span>
                    </button>
                </form>
            </div>
        </div>

        <!-- Admin Dashboard -->
        <div class="admin-dashboard" id="adminDashboard" style="display: none;">
            <nav class="admin-nav">
                <div class="nav-container">
                    <a href="/" class="logo">Solera Cask Admin</a>
                    <div class="admin-user">
                        <span id="welcomeUser">Welcome, Admin</span>
                        <button onclick="logout()" class="logout-btn">Logout</button>
                    </div>
                </div>
            </nav>

            <div class="admin-content">
                <div class="admin-sidebar">
                    <ul class="admin-menu">
                        <li><a href="#" onclick="showSection('posts')" class="active">Manage Posts</a></li>
                        <li><a href="#" onclick="showSection('add-post')">Add New Post</a></li>
                        <li><a href="#" onclick="showSection('featured')">Featured Post</a></li>
                        <li><a href="#" onclick="showSection('settings')">Settings</a></li>
                        <li><a href="/">View Website</a></li>
                    </ul>
                </div>

                <div class="admin-main">
                    <!-- Posts Management Section -->
                    <div class="admin-section active" id="posts-section">
                        <div class="section-header">
                            <h2 class="section-title">Dashboard Overview</h2>
                        </div>
                        
                        <div class="stats-grid">
                            <div class="stat-card">
                                <div class="stat-number" id="stat-total">0</div>
                                <div class="stat-label">Total Posts</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-number" id="stat-published">0</div>
                                <div class="stat-label">Published</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-number" id="stat-drafts">0</div>
                                <div class="stat-label">Drafts</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-number" id="stat-featured">0</div>
                                <div class="stat-label">Featured</div>
                            </div>
                        </div>

                        <h2>Manage Posts</h2>
                        <div class="posts-table-container">
                            <table class="posts-table">
                                <thead>
                                    <tr>
                                        <th>Title</th>
                                        <th>Type</th>
                                        <th>Date</th>
                                        <th>Status</th>
                                        <th>Featured</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="postsTableBody">
                                    <tr>
                                        <td colspan="6" style="text-align: center; padding: 3rem; color: var(--text-light);">
                                            <div class="loading-spinner"></div> Loading posts...
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                   <!-- Enhanced Add/Edit Post Section with SEO -->
                    <div class="admin-section" id="add-post-section">
                        <h2 id="postFormTitle">Add New Post</h2>
                        <form class="post-form" id="postForm">
                            <!-- Basic Post Information -->
                            <div class="form-section">
                                <h3 class="section-title">
                                    <span class="section-icon">📝</span>
                                    Post Content
                                </h3>
                                
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="postTitle">Title *</label>
                                        <input type="text" id="postTitle" name="title" required>
                                    </div>
                                    <div class="form-group">
                                        <label for="postType">Type *</label>
                                        <select id="postType" name="type" required>
                                            <option value="News">News & Updates</option>
                                            <option value="Education">Education</option>
                                            <option value="Tasting Notes">Tasting Notes</option>
                                            <option value="Stories">Stories & Heritage</option>
                                            <option value="Partnership">Partnership</option>
                                            <option value="Product Launch">Product Launch</option>
                                        </select>
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label for="postExcerpt">Excerpt/Summary *</label>
                                    <textarea id="postExcerpt" name="excerpt" rows="3" placeholder="Brief summary for post preview..." required></textarea>
                                </div>
                                
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="postLink">External Link (Optional)</label>
                                        <input type="url" id="postLink" name="link" placeholder="https://example.com">
                                    </div>
                                    <div class="form-group">
                                        <label for="postTags">Tags (comma-separated)</label>
                                        <input type="text" id="postTags" name="tags" placeholder="sherry, barrels, whisky, aging">
                                    </div>
                                </div>
                                
                                <div class="form-group">
                                    <label for="postStatus">Status</label>
                                    <select id="postStatus" name="status">
                                        <option value="published">Published</option>
                                        <option value="draft">Draft</option>
                                    </select>
                                </div>
                            </div>

                            <!-- SEO Optimization Section -->
                            <div class="form-section seo-section">
                                <h3 class="section-title">
                                    <span class="section-icon">🔍</span>
                                    SEO Optimization
                                    <button type="button" class="auto-seo-btn" onclick="generateAllSEO()">Auto-Generate SEO</button>
                                </h3>
                                
                                <div class="form-group">
                                    <label for="seoTitle">SEO Title</label>
                                    <input type="text" id="seoTitle" name="seoTitle" maxlength="60" placeholder="Optimized title for search results">
                                    <div class="char-count" id="seoTitleCount">0/60</div>
                                    <div class="help-text">Recommended: 50-60 characters. This appears as the clickable headline in search results.</div>
                                </div>

                                <div class="form-group">
                                    <label for="seoDescription">SEO Description</label>
                                    <textarea id="seoDescription" name="seoDescription" maxlength="160" rows="3" placeholder="Compelling description that encourages clicks from search results"></textarea>
                                    <div class="char-count" id="seoDescriptionCount">0/160</div>
                                    <div class="help-text">Recommended: 150-160 characters. This appears below your title in search results.</div>
                                </div>

                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="seoKeywords">Focus Keywords</label>
                                        <input type="text" id="seoKeywords" name="seoKeywords" placeholder="sherry barrels, whisky aging, Jerez, Spain">
                                        <div class="help-text">Comma-separated keywords that describe your content.</div>
                                    </div>
                                    <div class="form-group">
                                        <label for="seoImage">Featured Image URL</label>
                                        <input type="text" id="seoImage" name="seoImage" placeholder="/images/blog/your-featured-image.jpg">
                                        <div class="help-text">Image for social media sharing (1200x630px recommended).</div>
                                    </div>
                                </div>

                                <!-- SEO Preview -->
                                <div class="seo-preview">
                                    <h4>Search Result Preview</h4>
                                    <div class="search-preview">
                                        <div class="preview-title" id="previewTitle">Your SEO Title - Solera Cask</div>
                                        <div class="preview-url" id="previewUrl">https://soleracask.com/post/your-post-slug</div>
                                        <div class="preview-description" id="previewDescription">Your SEO description will appear here...</div>
                                    </div>
                                </div>

                                <!-- Advanced SEO (Collapsible) -->
                                <div class="advanced-seo">
                                    <button type="button" class="toggle-advanced" onclick="toggleAdvancedSEO()">
                                        <span id="advancedToggleIcon">▶</span> Advanced SEO Settings
                                    </button>
                                    <div class="advanced-seo-content" id="advancedSEOContent" style="display: none;">
                                        <div class="form-row">
                                            <div class="form-group">
                                                <label for="canonicalUrl">Canonical URL (optional)</label>
                                                <input type="text" id="canonicalUrl" name="canonicalUrl" placeholder="https://soleracask.com/post/custom-url">
                                                <div class="help-text">Use only if this content appears on multiple URLs</div>
                                            </div>
                                            <div class="form-group">
                                                <label for="author">Author</label>
                                                <input type="text" id="author" name="author" placeholder="Author name">
                                            </div>
                                        </div>

                                        <div class="checkbox-group">
                                            <input type="checkbox" id="noIndex" name="noIndex">
                                            <label for="noIndex">No Index (prevent search engines from indexing this post)</label>
                                        </div>

                                        <div class="checkbox-group">
                                            <input type="checkbox" id="autoGenerateSEO" name="autoGenerateSEO" checked>
                                            <label for="autoGenerateSEO">Auto-generate missing SEO fields when saving</label>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Featured Post Controls -->
                            <div class="featured-controls">
                                <h3 style="margin-bottom: 16px; color: var(--text-primary);">Featured Post Settings</h3>
                                <div class="featured-checkbox">
                                    <input type="checkbox" id="postFeatured" name="featured">
                                    <label for="postFeatured" style="text-transform: none; font-size: 14px;">Set as Featured Post (appears on homepage)</label>
                                </div>
                                <div class="featured-image-upload" id="featuredImageUpload" style="display: none;">
                                    <label for="featuredImage">Featured Image for Homepage</label>
                                    <input type="file" id="featuredImage" accept="image/*">
                                    <div class="featured-image-preview" id="featuredImagePreview"></div>
                                </div>
                            </div>

                           <!-- Content Format Toggle -->
                            <div class="form-group">
                                <label>Content Format</label>
                                <div class="content-format-toggle">
                                    <div class="format-toggle-buttons">
                                        <button type="button" class="format-toggle-btn active" onclick="setContentFormat('markdown')">Markdown</button>
                                        <button type="button" class="format-toggle-btn" onclick="setContentFormat('html')">HTML</button>
                                    </div>
                                </div>
                            </div>

                            <!-- Markdown Content (default) -->
                            <div class="form-group" id="markdownContent">
                                <label for="postContent">Full Content *</label>
                                <textarea id="postContent" name="content" rows="10" placeholder="Full post content..." required></textarea>
                                <div class="content-helper">
                                    <small style="color: var(--text-light); font-size: 12px; margin-top: 8px; display: block;">
                                        Tip: Add images by dragging them to the upload area below, then copy the image code into your content where you want it to appear.
                                    </small>
                                </div>
                            </div>

                            <!-- HTML Content -->
                            <div class="form-group" id="htmlContent" style="display: none;">
                                <label for="postContentHtml">HTML Content *</label>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                                    <div>
                                        <textarea id="postContentHtml" name="contentHtml" class="html-editor" placeholder="<h2>Your HTML content here...</h2>
                            <p>You can use full HTML markup including:</p>
                            <ul>
                            <li>Images and videos</li>
                            <li>Custom styling</li>
                            <li>Interactive elements</li>
                            </ul>"></textarea>
                                    </div>
                                    <div>
                                        <div class="preview-header">
                                            <span class="preview-title">Live Preview</span>
                                            <button type="button" class="refresh-preview-btn" onclick="refreshHTMLPreview()">Refresh</button>
                                        </div>
                                        <div id="htmlPreview" class="html-preview">
                                            <p style="color: var(--text-light); font-style: italic;">Preview will appear here...</p>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Image Upload Section -->
                            <div class="form-group">
                                <label for="imageUpload">Post Images</label>
                                <div class="image-upload-container">
                                    <div class="image-drop-zone" id="imageDropZone">
                                        <div class="drop-zone-content">
                                            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                                                <circle cx="8.5" cy="8.5" r="1.5"/>
                                                <polyline points="21,15 16,10 5,21"/>
                                            </svg>
                                            <p>Drag & drop images here or <span class="browse-link">browse files</span></p>
                                            <small>Supports JPG, PNG, GIF up to 5MB</small>
                                        </div>
                                        <input type="file" id="imageFileInput" accept="image/*" multiple style="display: none;">
                                    </div>
                                    <div class="uploaded-images" id="uploadedImages">
                                        <!-- Uploaded images will appear here -->
                                    </div>
                                </div>
                            </div>

                            <!-- Form Actions -->
                            <div class="form-actions">
                                <button type="submit" class="btn-primary">
                                    <span class="btn-text">Save Post</span>
                                    <span class="loading-spinner" style="display: none;"></span>
                                </button>
                                <button type="button" onclick="cancelEdit()" class="btn-secondary">Cancel</button>
                            </div>
                            <input type="hidden" id="editPostId" name="id">
                        </form>
                    </div>

                    <!-- Featured Post Management Section -->
                    <div class="admin-section" id="featured-section">
                        <h2>Featured Post Management</h2>
                        <div class="post-form">
                            <h3 style="margin-bottom: 24px; color: var(--text-primary);">Current Featured Post</h3>
                            <div id="currentFeaturedPost">
                                <p style="color: var(--text-light); font-style: italic;">No featured post set</p>
                            </div>
                            
                            <h3 style="margin: 40px 0 24px; color: var(--text-primary);">Select Featured Post</h3>
                            <div class="form-group">
                                <label for="featuredPostSelect">Choose Post to Feature</label>
                                <select id="featuredPostSelect">
                                    <option value="">No featured post</option>
                                </select>
                            </div>
                            
                            <div class="form-actions">
                                <button onclick="updateFeaturedPost()" class="btn-primary">
                                    <span class="btn-text">Update Featured Post</span>
                                    <span class="loading-spinner" style="display: none;"></span>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Settings Section -->
                    <div class="admin-section" id="settings-section">
                        <h2>Settings</h2>
                        <div class="post-form">
                            <div class="form-group">
                                <h3 style="margin-bottom: 24px; color: var(--text-primary);">Admin Settings</h3>
                                <label for="newPassword">Change Password</label>
                                <input type="password" id="newPassword" placeholder="Enter new password">
                            </div>
                            <div class="form-group">
                                <label for="confirmPassword">Confirm Password</label>
                                <input type="password" id="confirmPassword" placeholder="Confirm new password">
                            </div>
                            
                            <div class="form-actions">
                                <button onclick="changePassword()" class="btn-primary">
                                    <span class="btn-text">Update Password</span>
                                    <span class="loading-spinner" style="display: none;"></span>
                                </button>
                                <button onclick="exportData()" class="btn-secondary">Export Posts</button>
                                <button onclick="importData()" class="btn-secondary">Import Posts</button>
                            </div>
                            <input type="file" id="importFile" accept=".json" style="display: none;">
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
       let posts = [];
        let currentEditId = null;
        let authToken = null;
        let currentContentFormat = 'markdown';
        const uploadedImages = new Map();

        // Determine API base URL based on environment
        const API_BASE = window.location.hostname.includes('localhost') || window.location.hostname.includes('127.0.0.1')
            ? '/api'
            : '/api'; // Update to your production API URL if not using Netlify Functions

        // Enhanced error handling for API requests
        async function apiRequest(endpoint, options = {}) {
            const url = `${API_BASE}${endpoint}`;
            
            const defaultOptions = {
                headers: {
                    'Content-Type': 'application/json',
                    ...(authToken && { 'Authorization': `Bearer ${authToken}` })
                }
            };

            const finalOptions = {
                ...defaultOptions,
                ...options,
                headers: {
                    ...defaultOptions.headers,
                    ...options.headers
                }
            };

            try {
                const response = await fetch(url, finalOptions);
                
                if (!response.ok) {
                    if (response.status === 401 || response.status === 403) {
                        logout();
                        throw new Error('Authentication required');
                    }
                    
                    let errorData;
                    try {
                        errorData = await response.json();
                    } catch {
                        errorData = { message: `HTTP ${response.status}` };
                    }
                    
                    throw new Error(errorData.message || `Request failed: ${response.status}`);
                }

                return await response.json();
            } catch (error) {
                console.error('API Request failed:', error);
                throw error;
            }
        }

        // Enhanced Blog API with Cloudinary support
        window.SoleraBlogAPI = {
            // Authentication
            login: async function(username, password) {
                const response = await apiRequest('/login', {
                    method: 'POST',
                    body: JSON.stringify({ username, password })
                });
                
                authToken = response.token;
                localStorage.setItem('solera-admin-token', authToken);
                localStorage.setItem('solera-admin-user', JSON.stringify(response.user));
                
                return response;
            },

            // Get all posts (admin only)
            getAllPosts: async function() {
                return await apiRequest('/posts');
            },

            // Get single post by ID (admin only)
            getPost: async function(id) {
                return await apiRequest(`/posts/${id}`);
            },

            // Get featured post
            getFeaturedPost: async function() {
                return await apiRequest('/featured-post');
            },

            // Set featured post
            setFeaturedPost: async function(postId) {
                return await apiRequest('/featured-post', {
                    method: 'POST',
                    body: JSON.stringify({ postId })
                });
            },

            clearFeaturedPost: async function() {
                return await apiRequest('/featured-post', {
                    method: 'POST',
                    body: JSON.stringify({ postId: null })
                });
            },

            // Create new post
            addPost: async function(postData) {
                return await apiRequest('/posts', {
                    method: 'POST',
                    body: JSON.stringify(postData)
                });
            },

            // Update existing post
            updatePost: async function(id, postData) {
                return await apiRequest(`/posts/${id}`, {
                    method: 'PUT',
                    body: JSON.stringify(postData)
                });
            },

            deletePost: async function(id) {
                return await apiRequest(`/posts/${id}`, {
                    method: 'DELETE'
                });
            },

            // ✅ FIXED: Upload image to Cloudinary
            uploadImage: async function(file) {
                const formData = new FormData();
                formData.append('image', file);
                
                const url = `${API_BASE}/images/upload`;
                
                try {
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: {
                            // ✅ FIXED: Don't set Content-Type for FormData uploads
                            'Authorization': authToken ? `Bearer ${authToken}` : undefined
                        },
                        body: formData
                    });
                    
                    if (!response.ok) {
                        if (response.status === 401 || response.status === 403) {
                            logout();
                            throw new Error('Authentication required');
                        }
                        
                        let errorData;
                        try {
                            errorData = await response.json();
                        } catch {
                            errorData = { message: `HTTP ${response.status}` };
                        }
                        
                        throw new Error(errorData.message || `Upload failed: ${response.status}`);
                    }

                    return await response.json();
                } catch (error) {
                    console.error('Upload failed:', error);
                    throw error;
                }
            },

            // Change password
            changePassword: async function(newPassword, confirmPassword) {
                return await apiRequest('/user/password', {
                    method: 'PUT',
                    body: JSON.stringify({ newPassword, confirmPassword })
                });
            },

            // Get dashboard stats
            getStats: function(allPosts) {
                return {
                    total: allPosts.length,
                    published: allPosts.filter(post => post.status === 'published').length,
                    drafts: allPosts.filter(post => post.status === 'draft').length,
                    featured: allPosts.filter(post => post.featured === true).length
                };
            },

            // Fallback to localStorage for offline functionality
            getLocalPosts: function() {
                const posts = localStorage.getItem('solera-cask-posts-cache');
                return posts ? JSON.parse(posts) : [];
            },

            saveLocalPosts: function(posts) {
                localStorage.setItem('solera-cask-posts-cache', JSON.stringify(posts));
            }
        };

        // ✅ FIXED: Handle file uploads with proper Cloudinary integration
        async function handleFiles(files) {
            console.log('handleFiles called with', files.length, 'files');
            
            const uploadedImagesContainer = document.getElementById('uploadedImages');
            if (!uploadedImagesContainer) {
                console.error('uploadedImages container not found');
                return;
            }

            for (const file of files) {
                console.log('Processing file:', file.name, file.type, file.size);
                
                if (!file.type.startsWith('image/')) {
                    showMessage('Please upload only image files', 'error');
                    continue;
                }

                if (file.size > 5 * 1024 * 1024) {
                    showMessage('Image size must be less than 5MB', 'error');
                    continue;
                }

                try {
                    showMessage('Uploading image to Cloudinary...', 'info');
                    console.log('Starting Cloudinary upload for:', file.name);
                    
                    const response = await SoleraBlogAPI.uploadImage(file);
                    console.log('Cloudinary upload successful, response:', response);
                    
                    addImageToPost(response.id, response.url, response.originalName || file.name);
                    showMessage('Image uploaded to Cloudinary successfully!', 'success');
                } catch (error) {
                    console.error('Cloudinary upload error:', error);
                    showMessage('Failed to upload image: ' + error.message, 'error');
                }
            }
        }

        // ✅ FIXED: Handle featured image upload
        async function handleFeaturedImageUpload(file) {
            if (!file) {
                throw new Error('No file provided');
            }

            console.log('Uploading featured image to Cloudinary:', file.name);
            try {
                const response = await SoleraBlogAPI.uploadImage(file);
                console.log('Featured image Cloudinary upload response:', response);
                return response.url; // Return Cloudinary URL
            } catch (error) {
                console.error('Failed to upload featured image to Cloudinary:', error);
                throw error;
            }
        }

        // ✅ UPDATED: Add image with Cloudinary URL
        function addImageToPost(imageId, cloudinaryUrl, filename) {
            console.log('addImageToPost called with:', { imageId, filename, cloudinaryUrl });
            
            const uploadedImagesContainer = document.getElementById('uploadedImages');
            if (!uploadedImagesContainer) {
                console.error('uploadedImages container not found');
                return;
            }

            const imageElement = document.createElement('div');
            imageElement.className = 'uploaded-image';
            imageElement.setAttribute('data-image-id', imageId);
            imageElement.setAttribute('data-image-url', cloudinaryUrl);
            imageElement.setAttribute('data-filename', filename);

            const displayCode = currentContentFormat === 'html' 
                ? `<img src="${cloudinaryUrl}" alt="${filename}" style="max-width: 100%; height: auto;">`
                : `![${filename}](${cloudinaryUrl})`;
            
            imageElement.innerHTML = `
                <img src="${cloudinaryUrl}" alt="${filename}" style="max-width: 100px; height: auto;">
                <div class="image-info">${filename}</div>
                <div class="image-code" onclick="copyImageCodeFixed(this)" title="Click to copy">
                    ${displayCode}
                    <div class="copy-tooltip">Click to copy</div>
                </div>
                <div class="image-actions">
                    <button class="image-btn" onclick="insertImageAtCursorFixed(this)">Insert</button>
                    <button class="image-btn danger" onclick="removeImage(this)">Delete</button>
                </div>
            `;

            uploadedImagesContainer.appendChild(imageElement);
            console.log('Image added to container successfully with Cloudinary URL');
        }

        // ✅ FIXED: Copy image code with Cloudinary URL
        function copyImageCodeFixed(element) {
            const imageElement = element.closest('.uploaded-image');
            const imageUrl = imageElement.getAttribute('data-image-url');
            const filename = imageElement.getAttribute('data-filename');
            
            const actualImageCode = currentContentFormat === 'html' 
                ? `<img src="${imageUrl}" alt="${filename}" style="max-width: 100%; height: auto;">`
                : `![${filename}](${imageUrl})`;
            
            navigator.clipboard.writeText(actualImageCode).then(() => {
                const tooltip = element.querySelector('.copy-tooltip');
                const originalText = tooltip.textContent;
                tooltip.textContent = 'Copied!';
                tooltip.style.background = '#4CAF50';
                setTimeout(() => {
                    tooltip.textContent = originalText;
                    tooltip.style.background = '';
                }, 2000);
            }).catch(err => {
                console.error('Failed to copy: ', err);
                showMessage('Failed to copy image code', 'error');
            });
        }

        // ✅ FIXED: Insert image at cursor with Cloudinary URL
        function insertImageAtCursorFixed(element) {
            const imageElement = element.closest('.uploaded-image');
            const imageUrl = imageElement.getAttribute('data-image-url');
            const filename = imageElement.getAttribute('data-filename');
            
            const imageCode = currentContentFormat === 'html' 
                ? `<img src="${imageUrl}" alt="${filename}" style="max-width: 100%; height: auto;">`
                : `![${filename}](${imageUrl})`;
            
            const activeTextarea = currentContentFormat === 'html' 
                ? document.getElementById('postContentHtml')
                : document.getElementById('postContent');
            
            if (activeTextarea) {
                const cursorPos = activeTextarea.selectionStart;
                const textBefore = activeTextarea.value.substring(0, cursorPos);
                const textAfter = activeTextarea.value.substring(activeTextarea.selectionEnd);
                
                activeTextarea.value = textBefore + imageCode + textAfter;
                activeTextarea.focus();
                activeTextarea.setSelectionRange(
                    cursorPos + imageCode.length, 
                    cursorPos + imageCode.length
                );
                
                if (currentContentFormat === 'html') {
                    refreshHTMLPreview();
                }
                
                showMessage('Cloudinary image inserted into post content!', 'success');
            }
        }

        // ✅ UPDATED: Save post with Cloudinary featured image support
        async function savePost() {
            const formData = new FormData(document.getElementById('postForm'));
            const postData = {
                title: formData.get('title').trim(),
                type: formData.get('type'),
                excerpt: formData.get('excerpt').trim(),
                link: formData.get('link').trim(),
                tags: formData.get('tags').split(',').map(tag => tag.trim()).filter(tag => tag),
                status: formData.get('status'),
                featured: document.getElementById('postFeatured').checked
            };

            // Handle content based on format
            if (currentContentFormat === 'html') {
                postData.contentHtml = document.getElementById('postContentHtml').value.trim();
                postData.content = '';
            } else {
                postData.content = document.getElementById('postContent').value.trim();
                postData.contentHtml = '';
            }

            // ✅ FIXED: Handle featured image upload to Cloudinary
            if (postData.featured) {
                const featuredImageFile = document.getElementById('featuredImage').files[0];
                
                console.log('Featured image handling:', {
                    featured: postData.featured,
                    hasFile: !!featuredImageFile,
                    fileName: featuredImageFile?.name,
                    currentEditId: currentEditId
                });
                
                if (featuredImageFile) {
                    try {
                        showMessage('Uploading featured image to Cloudinary...', 'info');
                        const cloudinaryUrl = await handleFeaturedImageUpload(featuredImageFile);
                        postData.featuredImage = cloudinaryUrl;
                        console.log('Featured image uploaded to Cloudinary successfully:', cloudinaryUrl);
                    } catch (error) {
                        console.error('Featured image Cloudinary upload failed:', error);
                        showMessage('Featured image upload failed, saving post without featured image', 'warning');
                        postData.featuredImage = '';
                    }
                } else if (currentEditId) {
                    // Preserve existing featured image if editing and no new file is uploaded
                    const existingPost = posts.find(p => p.id === currentEditId);
                    postData.featuredImage = existingPost?.featuredImage || '';
                } else {
                    postData.featuredImage = '';
                }
            } else {
                postData.featuredImage = '';
            }

            const submitButton = document.querySelector('#postForm button[type="submit"]');
            const btnText = submitButton.querySelector('.btn-text');
            const spinner = submitButton.querySelector('.loading-spinner');

            try {
                // Show loading state
                if (btnText) btnText.style.display = 'none';
                if (spinner) spinner.style.display = 'inline-block';
                submitButton.disabled = true;

                if (currentEditId) {
                    await SoleraBlogAPI.updatePost(currentEditId, postData);
                    showMessage(`Post "${postData.title}" updated successfully!`, 'success');
                } else {
                    await SoleraBlogAPI.addPost(postData);
                    showMessage(`Post "${postData.title}" created successfully!`, 'success');
                }

                resetPostForm();
                loadPostsTable();
                loadDashboardStats();
                loadFeaturedPostSection();
                showSection('posts');
                
            } catch (error) {
                console.error('Error saving post:', error);
                showMessage('Failed to save post: ' + error.message, 'error');
            } finally {
                // Restore button state
                if (btnText) btnText.style.display = 'inline';
                if (spinner) spinner.style.display = 'none';
                submitButton.disabled = false;
            }
        }

        // Initialize admin panel
        document.addEventListener('DOMContentLoaded', function() {
            initializeAdmin();
            checkAuthStatus();
            initializeImageUpload();
            initializeFeaturedPostControls();
            initializeHTMLEditor();
            initializeImportHandler();
        });

        function initializeAdmin() {
            const loginForm = document.getElementById('loginForm');
            if (loginForm) {
                loginForm.addEventListener('submit', handleLogin);
            }

            const postForm = document.getElementById('postForm');
            if (postForm) {
                postForm.addEventListener('submit', handlePostSubmit);
            }

            // Auto-resize textareas
            document.addEventListener('input', function(e) {
                if (e.target.tagName === 'TEXTAREA') {
                    autoResizeTextarea(e.target);
                }
            });
        }

        // Initialize featured post controls
        function initializeFeaturedPostControls() {
            const featuredCheckbox = document.getElementById('postFeatured');
            const featuredImageUpload = document.getElementById('featuredImageUpload');
            const featuredImageInput = document.getElementById('featuredImage');

            if (featuredCheckbox) {
                featuredCheckbox.addEventListener('change', function() {
                    if (this.checked) {
                        featuredImageUpload.style.display = 'block';
                    } else {
                        featuredImageUpload.style.display = 'none';
                    }
                });
            }

            if (featuredImageInput) {
                featuredImageInput.addEventListener('change', function(e) {
                    const file = e.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            const preview = document.getElementById('featuredImagePreview');
                            preview.innerHTML = `<img src="${e.target.result}" alt="Featured image preview" style="max-width: 200px; max-height: 150px; object-fit: cover; border-radius: 4px;">`;
                        };
                        reader.readAsDataURL(file);
                    }
                });
            }
        }

        // Initialize HTML editor
        function initializeHTMLEditor() {
            const htmlEditor = document.getElementById('postContentHtml');
            if (htmlEditor) {
                htmlEditor.addEventListener('input', function() {
                    // Auto-refresh preview on typing (debounced)
                    clearTimeout(this.previewTimeout);
                    this.previewTimeout = setTimeout(refreshHTMLPreview, 500);
                });
            }
        }

        // Initialize import file handler
        function initializeImportHandler() {
            const importFileInput = document.getElementById('importFile');
            if (importFileInput) {
                importFileInput.addEventListener('change', async function(event) {
                    const file = event.target.files[0];
                    if (!file) return;
                    
                    const reader = new FileReader();
                    reader.onload = async function(e) {
                        try {
                            const postsData = JSON.parse(e.target.result);
                            
                            if (!Array.isArray(postsData)) {
                                throw new Error('Invalid file format. Expected JSON array of posts.');
                            }
                            
                            showMessage('Importing posts...', 'info');
                            
                            let imported = 0;
                            for (const postData of postsData) {
                                try {
                                    await SoleraBlogAPI.addPost(postData);
                                    imported++;
                                } catch (error) {
                                    console.warn('Failed to import post:', postData.title, error);
                                }
                            }
                            
                            showMessage(`Successfully imported ${imported} of ${postsData.length} posts`, 'success');
                            loadPostsTable();
                            loadDashboardStats();
                            loadFeaturedPostSection();
                            
                            event.target.value = '';
                        } catch (error) {
                            console.error('Error importing posts:', error);
                            showMessage('Error importing posts: ' + error.message, 'error');
                        }
                    };
                    reader.readAsText(file);
                });
            }
        }

       // ✅ FIXED: Content format switching with proper required field handling
        function setContentFormat(format) {
            currentContentFormat = format;
            
            // Update toggle buttons
            document.querySelectorAll('.format-toggle-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            const activeBtn = document.querySelector(`[onclick="setContentFormat('${format}')"]`);
            if (activeBtn) {
                activeBtn.classList.add('active');
            }
            
            // Get the textareas
            const markdownContent = document.getElementById('markdownContent');
            const htmlContent = document.getElementById('htmlContent');
            const markdownTextarea = document.getElementById('postContent');
            const htmlTextarea = document.getElementById('postContentHtml');
            
            if (markdownContent && htmlContent && markdownTextarea && htmlTextarea) {
                if (format === 'markdown') {
                    // Show markdown, hide HTML
                    markdownContent.style.display = 'block';
                    htmlContent.style.display = 'none';
                    
                    // ✅ FIX: Set required attributes properly
                    markdownTextarea.required = true;
                    htmlTextarea.required = false;
                    htmlTextarea.removeAttribute('required');
                    
                } else {
                    // Show HTML, hide markdown
                    markdownContent.style.display = 'none';
                    htmlContent.style.display = 'block';
                    
                    // ✅ FIX: Set required attributes properly
                    htmlTextarea.required = true;
                    markdownTextarea.required = false;
                    markdownTextarea.removeAttribute('required');
                    
                    refreshHTMLPreview();
                }
            }
        }

        // Refresh HTML preview
        function refreshHTMLPreview() {
            const htmlContent = document.getElementById('postContentHtml');
            const preview = document.getElementById('htmlPreview');
            
            if (htmlContent && preview) {
                if (htmlContent.value.trim()) {
                    preview.innerHTML = htmlContent.value;
                } else {
                    preview.innerHTML = '<p style="color: var(--text-light); font-style: italic;">Preview will appear here...</p>';
                }
            }
        }

        // Image Upload Functionality
        function initializeImageUpload() {
            const dropZone = document.getElementById('imageDropZone');
            const fileInput = document.getElementById('imageFileInput');
            const browseLink = document.querySelector('.browse-link');

            if (!dropZone || !fileInput) return;

            dropZone.addEventListener('click', () => fileInput.click());
            if (browseLink) {
                browseLink.addEventListener('click', (e) => {
                    e.stopPropagation();
                    fileInput.click();
                });
            }

            fileInput.addEventListener('change', (e) => {
                handleFiles(e.target.files);
            });

            dropZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropZone.classList.add('drag-over');
            });

            dropZone.addEventListener('dragleave', (e) => {
                e.preventDefault();
                dropZone.classList.remove('drag-over');
            });

            dropZone.addEventListener('drop', (e) => {
                e.preventDefault();
                dropZone.classList.remove('drag-over');
                handleFiles(e.dataTransfer.files);
            });
        }

        async function handleFeaturedImageUpload(file) {
            if (!file) {
                throw new Error('No file provided');
            }

            console.log('Uploading featured image:', file.name);
            try {
                const response = await SoleraBlogAPI.uploadImage(file);
                console.log('Featured image upload response:', response);
                return response.url;
            } catch (error) {
                console.error('Failed to upload featured image:', error);
                throw error;
            }
        }

        function copyImageCodeFixed(element) {
            const imageElement = element.closest('.uploaded-image');
            const imageUrl = imageElement.getAttribute('data-image-url');
            const filename = imageElement.getAttribute('data-filename');
            
            const actualImageCode = currentContentFormat === 'html' 
                ? `<img src="${imageUrl}" alt="${filename}" style="max-width: 100%; height: auto;">`
                : `![${filename}](${imageUrl})`;
            
            navigator.clipboard.writeText(actualImageCode).then(() => {
                const tooltip = element.querySelector('.copy-tooltip');
                const originalText = tooltip.textContent;
                tooltip.textContent = 'Copied!';
                tooltip.style.background = '#4CAF50';
                setTimeout(() => {
                    tooltip.textContent = originalText;
                    tooltip.style.background = '';
                }, 2000);
            }).catch(err => {
                console.error('Failed to copy: ', err);
                showMessage('Failed to copy image code', 'error');
            });
        }

        function insertImageAtCursorFixed(element) {
            const imageElement = element.closest('.uploaded-image');
            const imageUrl = imageElement.getAttribute('data-image-url');
            const filename = imageElement.getAttribute('data-filename');
            
            const imageCode = currentContentFormat === 'html' 
                ? `<img src="${imageUrl}" alt="${filename}" style="max-width: 100%; height: auto;">`
                : `![${filename}](${imageUrl})`;
            
            const activeTextarea = currentContentFormat === 'html' 
                ? document.getElementById('postContentHtml')
                : document.getElementById('postContent');
            
            if (activeTextarea) {
                const cursorPos = activeTextarea.selectionStart;
                const textBefore = activeTextarea.value.substring(0, cursorPos);
                const textAfter = activeTextarea.value.substring(activeTextarea.selectionEnd);
                
                activeTextarea.value = textBefore + imageCode + textAfter;
                activeTextarea.focus();
                activeTextarea.setSelectionRange(
                    cursorPos + imageCode.length, 
                    cursorPos + imageCode.length
                );
                
                if (currentContentFormat === 'html') {
                    refreshHTMLPreview();
                }
                
                showMessage('Image inserted into post content!', 'success');
            }
        }

        function removeImage(button) {
            const imageElement = button.closest('.uploaded-image');
            if (imageElement && confirm('Are you sure you want to delete this image?')) {
                imageElement.remove();
                showMessage('Image deleted', 'success');
            }
        }

        function clearUploadedImages() {
            const uploadedImagesContainer = document.getElementById('uploadedImages');
            if (uploadedImagesContainer) {
                uploadedImagesContainer.innerHTML = '';
            }
        }

        function checkAuthStatus() {
            authToken = localStorage.getItem('solera-admin-token');
            const userData = localStorage.getItem('solera-admin-user');
            
            if (authToken && userData) {
                try {
                    const user = JSON.parse(userData);
                    const welcomeElement = document.getElementById('welcomeUser');
                    if (welcomeElement) {
                        welcomeElement.textContent = `Welcome, ${user.username}`;
                    }
                    showAdminDashboard();
                    loadPostsTable();
                    loadDashboardStats();
                    loadFeaturedPostSection();
                } catch (error) {
                    console.error('Error parsing user data:', error);
                    logout();
                }
            } else {
                showLoginForm();
            }
        }

        function showLoginForm() {
            const loginContainer = document.getElementById('loginContainer');
            const adminDashboard = document.getElementById('adminDashboard');
            
            if (loginContainer) loginContainer.style.display = 'block';
            if (adminDashboard) adminDashboard.style.display = 'none';
        }

        function showAdminDashboard() {
            const loginContainer = document.getElementById('loginContainer');
            const adminDashboard = document.getElementById('adminDashboard');
            
            if (loginContainer) loginContainer.style.display = 'none';
            if (adminDashboard) adminDashboard.style.display = 'block';
        }

      // Authentication
            async function handleLogin(e) {
            e.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            const submitButton = e.target.querySelector('button[type="submit"]');
            const btnText = submitButton.querySelector('.btn-text');
            const spinner = submitButton.querySelector('.loading-spinner');

            try {
                if (btnText) btnText.style.display = 'none';
                if (spinner) spinner.style.display = 'inline-block';
                submitButton.disabled = true;

                const response = await SoleraBlogAPI.login(username, password);
                
                // ✅ SAVE THE TOKEN (This was missing before!)
                authToken = response.token;
                localStorage.setItem('solera-admin-token', authToken);
                localStorage.setItem('solera-admin-user', JSON.stringify(response.user));
                
                const welcomeElement = document.getElementById('welcomeUser');
                if (welcomeElement) {
                            welcomeElement.textContent = `Welcome, ${response.user.username}`;
                        }
                        
                        showAdminDashboard();
                        loadPostsTable();
                        loadDashboardStats();
                        loadFeaturedPostSection();
                        showMessage('Welcome to Solera Cask Admin!', 'success');
                    } catch (error) {
                        console.error('Login error:', error);
                        showMessage('Login failed: ' + error.message, 'error');
                    } finally {
                        if (btnText) btnText.style.display = 'inline';
                        if (spinner) spinner.style.display = 'none';
                        submitButton.disabled = false;
                    }
                }

                function logout() {
                    authToken = null;
                    localStorage.removeItem('solera-admin-token');
                    localStorage.removeItem('solera-admin-user');
                    showLoginForm();
                    showMessage('Logged out successfully', 'success');
                }
        // Section navigation
        function showSection(sectionName) {
            const sections = document.querySelectorAll('.admin-section');
            sections.forEach(section => section.classList.remove('active'));
            
            const targetSection = document.getElementById(sectionName + '-section');
            if (targetSection) {
                targetSection.classList.add('active');
            }
            
            const menuItems = document.querySelectorAll('.admin-menu a');
            menuItems.forEach(item => item.classList.remove('active'));
            
            const activeItem = document.querySelector(`[onclick="showSection('${sectionName}')"]`);
            if (activeItem) {
                activeItem.classList.add('active');
            }
            
            if (sectionName === 'add-post' && !currentEditId) {
                resetPostForm();
            } else if (sectionName === 'featured') {
                loadFeaturedPostSection();
            }
        }

        async function loadPostsTable() {
            try {
                posts = await SoleraBlogAPI.getAllPosts();
                SoleraBlogAPI.saveLocalPosts(posts);
                renderPostsTable(posts);
            } catch (error) {
                console.error('Error loading posts:', error);
                showMessage('Failed to load posts: ' + error.message, 'error');
                
                const cachedPosts = SoleraBlogAPI.getLocalPosts();
                if (cachedPosts.length > 0) {
                    posts = cachedPosts;
                    renderPostsTable(posts);
                    showMessage('Loaded cached posts (offline mode)', 'info');
                }
            }
        }

        function renderPostsTable(postsToRender) {
            const tableBody = document.getElementById('postsTableBody');
            if (!tableBody) return;
            
            if (postsToRender.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="6" style="text-align: center; padding: 3rem; color: var(--text-light);">
                            No posts found. <a href="#" onclick="showSection('add-post')" style="color: var(--primary);">Create your first post</a>.
                        </td>
                    </tr>
                `;
                return;
            }
            
            tableBody.innerHTML = postsToRender.map(post => `
                <tr class="${post.status === 'draft' ? 'draft-row' : ''}">
                    <td>
                        <div class="post-title-main">${post.title}${post.featured ? '<span class="featured-indicator">FEATURED</span>' : ''}</div>
                        <div class="post-meta-small">
                            <span>ID: ${post.id}</span>
                            ${post.excerpt ? `<span> • ${post.excerpt.substring(0, 50)}...</span>` : ''}
                        </div>
                    </td>
                    <td><span class="post-type-badge">${post.type}</span></td>
                    <td>${formatDate(post.createdAt || post.date)}</td>
                    <td><span class="status-badge status-${post.status || 'published'}">
                        ${(post.status || 'published').charAt(0).toUpperCase() + (post.status || 'published').slice(1)}
                    </span></td>
                    <td><span class="status-badge ${post.featured ? 'status-featured' : ''}">${post.featured ? 'Yes' : 'No'}</span></td>
                    <td>
                        <div class="action-buttons">
                            <button class="action-btn" onclick="editPost('${post.id}')" title="Edit Post">✏️</button>
                            <button class="action-btn" onclick="viewPost('${post.id}')" title="View Post">👁️</button>
                            <button class="action-btn" onclick="toggleFeatured('${post.id}')" title="Toggle Featured">${post.featured ? '⭐' : '☆'}</button>
                            <button class="action-btn" onclick="duplicatePost('${post.id}')" title="Duplicate Post">📋</button>
                            <button class="action-btn" onclick="deletePost('${post.id}')" title="Delete Post">🗑️</button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        async function loadDashboardStats() {
            try {
                const stats = SoleraBlogAPI.getStats(posts);
                
                const elements = {
                    total: document.getElementById('stat-total'),
                    published: document.getElementById('stat-published'),
                    drafts: document.getElementById('stat-drafts'),
                    featured: document.getElementById('stat-featured')
                };

                if (elements.total) elements.total.textContent = stats.total;
                if (elements.published) elements.published.textContent = stats.published;
                if (elements.drafts) elements.drafts.textContent = stats.drafts;
                if (elements.featured) elements.featured.textContent = stats.featured;
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }

        // Load featured post section
        async function loadFeaturedPostSection() {
            try {
                // Load all posts for the dropdown
                const allPosts = await SoleraBlogAPI.getAllPosts();
                const publishedPosts = allPosts.filter(post => post.status === 'published');
                
                const featuredPostSelect = document.getElementById('featuredPostSelect');
                if (featuredPostSelect) {
                    featuredPostSelect.innerHTML = '<option value="">No featured post</option>' +
                        publishedPosts.map(post => 
                            `<option value="${post.id}" ${post.featured ? 'selected' : ''}>${post.title}</option>`
                        ).join('');
                }

                // Get current featured post from API
                let featuredPost = null;
                try {
                    featuredPost = await SoleraBlogAPI.getFeaturedPost();
                } catch (error) {
                    if (error.message.includes('404')) {
                        // No featured post found, that's okay
                        featuredPost = null;
                    } else {
                        throw error;
                    }
                }
                
                const currentFeaturedPost = document.getElementById('currentFeaturedPost');
                
                if (currentFeaturedPost) {
                    if (featuredPost) {
                        currentFeaturedPost.innerHTML = `
                            <div style="border: 1px solid var(--border); padding: 20px; background: var(--warm-white);">
                                <h4 style="margin-bottom: 8px; color: var(--text-primary);">${featuredPost.title}</h4>
                                <p style="color: var(--text-secondary); margin-bottom: 12px;">${featuredPost.excerpt || 'No excerpt available'}</p>
                                <div style="font-size: 12px; color: var(--text-light);">
                                    <span class="post-type-badge">${featuredPost.type}</span>
                                    <span style="margin-left: 12px;">Published: ${formatDate(featuredPost.date)}</span>
                                </div>
                            </div>
                        `;
                    } else {
                        currentFeaturedPost.innerHTML = '<p style="color: var(--text-light); font-style: italic;">No featured post set</p>';
                    }
                }
            } catch (error) {
                console.error('Error loading featured post section:', error);
                showMessage('Failed to load featured post section', 'error');
            }
        }

        // Update featured post
        async function updateFeaturedPost() {
            const selectedPostId = document.getElementById('featuredPostSelect').value;
            
            try {
                if (selectedPostId) {
                    await SoleraBlogAPI.setFeaturedPost(selectedPostId);
                    showMessage('Featured post updated successfully!', 'success');
                } else {
                    await SoleraBlogAPI.clearFeaturedPost();
                    showMessage('Featured post cleared successfully!', 'success');
                }
                
                loadPostsTable();
                loadDashboardStats();
                loadFeaturedPostSection();
            } catch (error) {
                console.error('Error updating featured post:', error);
                showMessage('Failed to update featured post: ' + error.message, 'error');
            }
        }

        // Toggle featured status from table
        async function toggleFeatured(postId) {
            const post = posts.find(p => p.id === postId);
            if (!post) return;

            try {
                if (post.featured) {
                    // If currently featured, clear it
                    await SoleraBlogAPI.clearFeaturedPost();
                    showMessage(`"${post.title}" removed from featured`, 'success');
                } else {
                    // If not featured, set it as featured
                    await SoleraBlogAPI.setFeaturedPost(postId);
                    showMessage(`"${post.title}" set as featured post!`, 'success');
                }
                
                loadPostsTable();
                loadDashboardStats();
                loadFeaturedPostSection();
            } catch (error) {
                console.error('Error toggling featured status:', error);
                showMessage('Failed to update featured status: ' + error.message, 'error');
            }
        }

        function editPost(postId) {
            const post = posts.find(p => p.id === postId);
            if (!post) {
                showMessage('Post not found', 'error');
                return;
            }

            document.getElementById('postTitle').value = post.title;
            document.getElementById('postType').value = post.type;
            document.getElementById('postExcerpt').value = post.excerpt || '';
            
            // Handle content format
            if (post.contentHtml && post.contentHtml.trim()) {
                setContentFormat('html');
                document.getElementById('postContentHtml').value = post.contentHtml;
                setTimeout(() => refreshHTMLPreview(), 100);
            } else {
                setContentFormat('markdown');
                document.getElementById('postContent').value = post.content || '';
            }
            
            document.getElementById('postLink').value = post.link || '';
            document.getElementById('postTags').value = Array.isArray(post.tags) ? post.tags.join(', ') : '';
            document.getElementById('postStatus').value = post.status || 'published';
            document.getElementById('postFeatured').checked = post.featured || false;
            
            // Show/hide featured image upload based on featured status
            const featuredImageUpload = document.getElementById('featuredImageUpload');
            const featuredImagePreview = document.getElementById('featuredImagePreview');
            
            if (post.featured) {
                featuredImageUpload.style.display = 'block';
                if (post.featuredImage) {
                    featuredImagePreview.innerHTML = `
                        <div class="existing-featured-image">
                            <img src="${post.featuredImage}" alt="Current featured image" style="max-width: 200px; max-height: 150px; object-fit: cover; border-radius: 4px;">
                            <p style="margin-top: 5px; font-size: 12px; color: var(--text-light);">Current featured image (upload new to replace)</p>
                        </div>
                    `;
                } else {
                    featuredImagePreview.innerHTML = '<p style="color: var(--text-light); font-style: italic;">No featured image set</p>';
                }
            } else {
                featuredImageUpload.style.display = 'none';
                featuredImagePreview.innerHTML = '';
            }
            
            // Set current edit ID
            currentEditId = postId;
            
            // Update form title
            const formTitle = document.getElementById('postFormTitle');
            if (formTitle) {
                formTitle.textContent = `Edit Post: ${post.title}`;
            }
            
            // Update submit button text
            const submitButton = document.querySelector('#postForm button[type="submit"] .btn-text');
            if (submitButton) {
                submitButton.textContent = 'Update Post';
            }
            
            // Switch to add-post section
            showSection('add-post');
            
            // Show editing message
            showMessage(`Editing: ${post.title}`, 'info');
            
            // Auto-resize textareas if they have content
            setTimeout(() => {
                const contentTextarea = currentContentFormat === 'html' 
                    ? document.getElementById('postContentHtml')
                    : document.getElementById('postContent');
                
                if (contentTextarea) {
                    autoResizeTextarea(contentTextarea);
                }
                
                const excerptTextarea = document.getElementById('postExcerpt');
                if (excerptTextarea) {
                    autoResizeTextarea(excerptTextarea);
                }
            }, 200);
        }

        function viewPost(postId) {
            const post = posts.find(p => p.id === postId);
            if (!post) {
                showMessage('Post not found', 'error');
                return;
            }
            
            const postSlug = createPostSlug(post);
            window.open(`/post/${postSlug}`, '_blank');
        }

        async function duplicatePost(postId) {
            const post = posts.find(p => p.id === postId);
            if (!post) {
                showMessage('Post not found', 'error');
                return;
            }
            
            const duplicateData = {
                title: `${post.title} (Copy)`,
                type: post.type,
                excerpt: post.excerpt,
                content: post.content,
                contentHtml: post.contentHtml,
                link: post.link,
                tags: post.tags,
                status: 'draft',
                featured: false // Don't duplicate featured status
            };
            
            try {
                await SoleraBlogAPI.addPost(duplicateData);
                showMessage('Post duplicated successfully!', 'success');
                loadPostsTable();
                loadDashboardStats();
            } catch (error) {
                console.error('Error duplicating post:', error);
                showMessage('Failed to duplicate post: ' + error.message, 'error');
            }
        }

        async function deletePost(postId) {
            const post = posts.find(p => p.id === postId);
            if (!post) {
                showMessage('Post not found', 'error');
                return;
            }
            
            if (!confirm(`Are you sure you want to delete "${post.title}"?\n\nThis action cannot be undone.`)) {
                return;
            }
            
            try {
                await SoleraBlogAPI.deletePost(postId);
                showMessage(`Post "${post.title}" deleted successfully!`, 'success');
                loadPostsTable();
                loadDashboardStats();
                loadFeaturedPostSection();
            } catch (error) {
                console.error('Error deleting post:', error);
                showMessage('Failed to delete post: ' + error.message, 'error');
            }
        }

        function handlePostSubmit(e) {
            e.preventDefault();
            savePost();
        }

        async function savePost() {
            const formData = new FormData(document.getElementById('postForm'));
            const postData = {
                title: formData.get('title').trim(),
                type: formData.get('type'),
                excerpt: formData.get('excerpt').trim(),
                link: formData.get('link').trim(),
                tags: formData.get('tags').split(',').map(tag => tag.trim()).filter(tag => tag),
                status: formData.get('status'),
                featured: document.getElementById('postFeatured').checked
            };

            // Handle content based on format
            if (currentContentFormat === 'html') {
                postData.contentHtml = document.getElementById('postContentHtml').value.trim();
                postData.content = '';
            } else {
                postData.content = document.getElementById('postContent').value.trim();
                postData.contentHtml = '';
            }

            // Handle featured image
            if (postData.featured) {
                const featuredImageFile = document.getElementById('featuredImage').files[0];
                
                console.log('Featured image handling:', {
                    featured: postData.featured,
                    hasFile: !!featuredImageFile,
                    fileName: featuredImageFile?.name,
                    currentEditId: currentEditId
                });
                
                if (featuredImageFile) {
                    try {
                        showMessage('Processing featured image...', 'info');
                        const imageResponse = await handleFeaturedImageUpload(featuredImageFile);
                        postData.featuredImage = imageResponse;
                        console.log('Featured image processed successfully:', imageResponse);
                    } catch (error) {
                        console.error('Featured image upload failed:', error);
                        showMessage('Featured image upload failed, saving post without featured image', 'warning');
                        postData.featuredImage = '';
                    }
                } else if (currentEditId) {
                    // Preserve existing featured image if editing and no new file is uploaded
                    const existingPost = posts.find(p => p.id === currentEditId);
                    postData.featuredImage = existingPost?.featuredImage || '';
                } else {
                    postData.featuredImage = '';
                }
            } else {
                postData.featuredImage = '';
            }

            const submitButton = document.querySelector('#postForm button[type="submit"]');
            const btnText = submitButton.querySelector('.btn-text');
            const spinner = submitButton.querySelector('.loading-spinner');

            try {
                // Show loading state
                if (btnText) btnText.style.display = 'none';
                if (spinner) spinner.style.display = 'inline-block';
                submitButton.disabled = true;

                if (currentEditId) {
                    await SoleraBlogAPI.updatePost(currentEditId, postData);
                    showMessage(`Post "${postData.title}" updated successfully!`, 'success');
                } else {
                    await SoleraBlogAPI.addPost(postData);
                    showMessage(`Post "${postData.title}" created successfully!`, 'success');
                }

                resetPostForm();
                loadPostsTable();
                loadDashboardStats();
                loadFeaturedPostSection();
                showSection('posts');
                
            } catch (error) {
                console.error('Error saving post:', error);
                showMessage('Failed to save post: ' + error.message, 'error');
            } finally {
                // Restore button state
                if (btnText) btnText.style.display = 'inline';
                if (spinner) spinner.style.display = 'none';
                submitButton.disabled = false;
            }
        }


        function resetPostForm() {
            const form = document.getElementById('postForm');
            if (form) {
                form.reset();
            }
            
            currentEditId = null;
            
            const formTitle = document.getElementById('postFormTitle');
            if (formTitle) {
                formTitle.textContent = 'Add New Post';
            }
            
            const submitButton = document.querySelector('#postForm button[type="submit"] .btn-text');
            if (submitButton) {
                submitButton.textContent = 'Save Post';
            }

            // Reset content format to markdown
            setContentFormat('markdown');
            
            // Clear uploaded images
            clearUploadedImages();
            
            // Reset featured controls
            const featuredImageUpload = document.getElementById('featuredImageUpload');
            const featuredImagePreview = document.getElementById('featuredImagePreview');
            
            if (featuredImageUpload) featuredImageUpload.style.display = 'none';
            if (featuredImagePreview) featuredImagePreview.innerHTML = '';
        }

        function cancelEdit() {
            resetPostForm();
            showSection('posts');
        }

        function autoResizeTextarea(textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = textarea.scrollHeight + 'px';
        }

        function createPostSlug(post) {
            return post.title
                .toLowerCase()
                .replace(/[^a-z0-9\s-]/g, '')
                .replace(/\s+/g, '-')
                .replace(/-+/g, '-')
                .trim('-');
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });
        }

        function showMessage(message, type = 'info') {
            const existingMessages = document.querySelectorAll('.admin-message');
            existingMessages.forEach(msg => msg.remove());

            const messageDiv = document.createElement('div');
            messageDiv.className = `admin-message admin-message-${type}`;
            messageDiv.textContent = message;

            document.body.appendChild(messageDiv);

            setTimeout(() => {
                messageDiv.remove();
            }, 5000);
        }

        // Settings functions
        async function changePassword() {
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;

            if (!newPassword || !confirmPassword) {
                showMessage('Please fill in both password fields', 'error');
                return;
            }

            if (newPassword !== confirmPassword) {
                showMessage('Passwords do not match', 'error');
                return;
            }

            if (newPassword.length < 8) {
                showMessage('Password must be at least 8 characters long', 'error');
                return;
            }

            const changePasswordBtn = document.querySelector('.btn-primary');
            const btnText = changePasswordBtn.querySelector('.btn-text');
            const spinner = changePasswordBtn.querySelector('.loading-spinner');

            try {
                if (btnText) btnText.style.display = 'none';
                if (spinner) spinner.style.display = 'inline-block';
                changePasswordBtn.disabled = true;

                await SoleraBlogAPI.changePassword(newPassword, confirmPassword);
                showMessage('Password updated successfully', 'success');
                document.getElementById('newPassword').value = '';
                document.getElementById('confirmPassword').value = '';
            } catch (error) {
                console.error('Error changing password:', error);
                showMessage('Failed to change password: ' + error.message, 'error');
            } finally {
                if (btnText) btnText.style.display = 'inline';
                if (spinner) spinner.style.display = 'none';
                changePasswordBtn.disabled = false;
            }
        }

        async function exportData() {
            try {
                const allPosts = await SoleraBlogAPI.getAllPosts();
                const blob = new Blob([JSON.stringify(allPosts, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `solera-cask-posts-${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                showMessage('Posts exported successfully', 'success');
            } catch (error) {
                console.error('Error exporting data:', error);
                showMessage('Failed to export posts: ' + error.message, 'error');
            }
        }

        function importData() {
            const importFile = document.getElementById('importFile');
            if (importFile) {
                importFile.click();
            }
        }
        // Enhanced SEO functionality
        function setupSEOFeatures() {
            // Character counting
            const seoFields = [
                { id: 'seoTitle', countId: 'seoTitleCount', max: 60 },
                { id: 'seoDescription', countId: 'seoDescriptionCount', max: 160 }
            ];

            seoFields.forEach(field => {
                const input = document.getElementById(field.id);
                const counter = document.getElementById(field.countId);
                
                if (input && counter) {
                    input.addEventListener('input', function() {
                        const length = this.value.length;
                        counter.textContent = `${length}/${field.max}`;
                        
                        counter.className = 'char-count';
                        if (length > field.max * 0.9) {
                            counter.classList.add('warning');
                        }
                        if (length > field.max) {
                            counter.classList.add('error');
                        }
                        
                        updateSEOPreview();
                    });
                }
            });

            // Auto-update preview when main fields change
            ['postTitle', 'seoTitle', 'seoDescription'].forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field) {
                    field.addEventListener('input', updateSEOPreview);
                }
            });

            // Initial setup
            updateSEOPreview();
        }

        function generateAllSEO() {
            generateSEOTitle();
            generateSEODescription();
            generateSEOKeywords();
        }

        function generateSEOTitle() {
            const postTitle = document.getElementById('postTitle').value;
            if (postTitle) {
                let seoTitle = `${postTitle} - Solera Cask`;
                if (seoTitle.length > 60) {
                    seoTitle = seoTitle.substring(0, 57) + '...';
                }
                document.getElementById('seoTitle').value = seoTitle;
                document.getElementById('seoTitle').dispatchEvent(new Event('input'));
            }
        }

        function generateSEODescription() {
            const postTitle = document.getElementById('postTitle').value;
            const postType = document.getElementById('postType').value || 'article';
            const excerpt = document.getElementById('postExcerpt').value;
            
            let description = '';
            
            if (excerpt) {
                description = excerpt;
            } else {
                const templates = {
                    'Education': `Learn about ${postTitle.toLowerCase()} with expert guidance from Solera Cask. Discover premium sherry barrels from Jerez de la Frontera, Spain.`,
                    'News': `Latest news: ${postTitle}. Stay updated with Solera Cask's premium sherry barrel innovations from Jerez de la Frontera, Spain.`,
                    'Stories': `Discover the story behind ${postTitle.toLowerCase()}. Premium sherry barrels and authentic craftsmanship from Jerez de la Frontera, Spain.`,
                    'default': `Read about ${postTitle.toLowerCase()} and discover premium sherry barrels from Jerez de la Frontera, Spain.`
                };
                description = templates[postType] || templates['default'];
            }
            
            if (description.length > 160) {
                const lastSpace = description.lastIndexOf(' ', 157);
                description = description.substring(0, lastSpace) + '...';
            }

            document.getElementById('seoDescription').value = description;
            document.getElementById('seoDescription').dispatchEvent(new Event('input'));
        }

        function generateSEOKeywords() {
            const postTitle = document.getElementById('postTitle').value;
            const postType = document.getElementById('postType').value;
            const postTags = document.getElementById('postTags').value;
            
            const baseKeywords = ['sherry barrels', 'Solera Cask', 'Jerez de la Frontera', 'Spain'];
            let keywords = [...baseKeywords];
            
            // Add tags if provided
            if (postTags) {
                const tags = postTags.split(',').map(tag => tag.trim()).filter(tag => tag);
                keywords.push(...tags.slice(0, 3));
            }
            
            // Add keywords from title
            const titleKeywords = postTitle.toLowerCase()
                .replace(/[^a-z0-9\s]/g, '')
                .split(' ')
                .filter(word => word.length > 3)
                .slice(0, 2);
            keywords.push(...titleKeywords);
            
            if (postType) {
                keywords.push(postType.toLowerCase());
            }
            
            // Remove duplicates and limit to 8 keywords
            keywords = [...new Set(keywords)].slice(0, 8);
            document.getElementById('seoKeywords').value = keywords.join(', ');
        }

        function updateSEOPreview() {
            const postTitle = document.getElementById('postTitle').value;
            const seoTitle = document.getElementById('seoTitle').value || (postTitle ? `${postTitle} - Solera Cask` : 'Your SEO Title - Solera Cask');
            const seoDescription = document.getElementById('seoDescription').value || 'Your SEO description will appear here...';
            
            document.getElementById('previewTitle').textContent = seoTitle;
            document.getElementById('previewDescription').textContent = seoDescription;
            
            // Update URL preview
            if (postTitle) {
                const slug = postTitle.toLowerCase()
                    .replace(/[^a-z0-9\s-]/g, '')
                    .replace(/\s+/g, '-')
                    .replace(/-+/g, '-')
                    .trim('-');
                document.getElementById('previewUrl').textContent = `https://soleracask.com/post/${slug}`;
            }
        }

        function toggleAdvancedSEO() {
            const content = document.getElementById('advancedSEOContent');
            const icon = document.getElementById('advancedToggleIcon');
            
            if (content.style.display === 'none') {
                content.style.display = 'block';
                icon.textContent = '▼';
            } else {
                content.style.display = 'none';
                icon.textContent = '▶';
            }
        }

        // Enhanced image upload functionality
        function setupImageUpload() {
            const uploadArea = document.getElementById('uploadArea');
            const imageInput = document.getElementById('imageInput');
            
            uploadArea.addEventListener('click', () => imageInput.click());
            
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });
            
            uploadArea.addEventListener('dragleave', () => {
                uploadArea.classList.remove('dragover');
            });
            
            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                const files = e.dataTransfer.files;
                handleImageFiles(files);
            });
            
            imageInput.addEventListener('change', (e) => {
                handleImageFiles(e.target.files);
            });
        }

        function handleImageFiles(files) {
            Array.from(files).forEach(file => {
                if (file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        addUploadedImage(file.name, e.target.result);
                    };
                    reader.readAsDataURL(file);
                }
            });
        }

        function addUploadedImage(filename, dataUrl) {
            const uploadedImages = document.getElementById('uploadedImages');
            const imageId = 'img-' + Date.now();
            
            const imageDiv = document.createElement('div');
            imageDiv.className = 'uploaded-image';
            imageDiv.innerHTML = `
                <img src="${dataUrl}" alt="${filename}">
                <div class="image-actions">
                    <button class="image-action-btn" onclick="copyImageCode('${imageId}')">Copy</button>
                    <button class="image-action-btn" onclick="removeImage('${imageId}')">×</button>
                </div>
                <div class="image-info">
                    <div>${filename}</div>
                    <div id="${imageId}" style="font-family: monospace; font-size: 10px; word-break: break-all;">
                        ![${filename}](${dataUrl})
                    </div>
                </div>
            `;
            imageDiv.id = imageId;
            
            uploadedImages.appendChild(imageDiv);
        }

        function copyImageCode(imageId) {
            const codeElement = document.getElementById(imageId).lastElementChild;
            const text = codeElement.textContent;
            
            navigator.clipboard.writeText(text).then(() => {
                showMessage('Image code copied to clipboard!', 'success');
            });
        }

        function removeImage(imageId) {
            const imageElement = document.getElementById(imageId);
            if (imageElement) {
                imageElement.remove();
            }
        }

        function clearUploadedImages() {
            document.getElementById('uploadedImages').innerHTML = '';
        }

        // Enhanced form submission to include SEO data
        function enhancedSavePost() {
            const formData = new FormData(document.getElementById('postForm'));
            
            // Collect all form data including SEO fields
            const postData = {
                title: formData.get('title').trim(),
                type: formData.get('type'),
                excerpt: formData.get('excerpt').trim(),
                content: formData.get('content').trim(),
                link: formData.get('link').trim(),
                tags: formData.get('tags').split(',').map(tag => tag.trim()).filter(tag => tag),
                status: formData.get('status'),
                
                // SEO fields
                seoTitle: formData.get('seoTitle').trim(),
                seoDescription: formData.get('seoDescription').trim(),
                seoKeywords: formData.get('seoKeywords').trim(),
                seoImage: formData.get('seoImage').trim(),
                canonicalUrl: formData.get('canonicalUrl').trim(),
                author: formData.get('author').trim(),
                noIndex: formData.get('noIndex') === 'on',
                autoGenerateSEO: formData.get('autoGenerateSEO') === 'on'
            };

            if (!postData.title || !postData.content) {
                showMessage('Title and content are required', 'error');
                return;
            }

            const submitButton = document.querySelector('#postForm button[type="submit"]');
            const originalText = submitButton.textContent;
            submitButton.textContent = 'Saving...';
            submitButton.disabled = true;

            try {
                if (currentEditId) {
                    SoleraBlogAPI.updatePost(currentEditId, postData);
                    showMessage(`Post "${postData.title}" updated successfully!`, 'success');
                } else {
                    SoleraBlogAPI.addPost(postData);
                    showMessage(`Post "${postData.title}" created successfully!`, 'success');
                }

                resetPostForm();
                loadPostsTable();
                loadDashboardStats();
                showSection('posts');
            } catch (error) {
                console.error('Error saving post:', error);
                showMessage('Error saving post: ' + error.message, 'error');
            } finally {
                submitButton.textContent = originalText;
                submitButton.disabled = false;
            }
        }

        // Initialize all features when page loads
        document.addEventListener('DOMContentLoaded', function() {
            setupSEOFeatures();
            setupImageUpload();
            
            // Replace the original savePost function
            window.savePost = enhancedSavePost;
        });

        // Global functions
        window.generateAllSEO = generateAllSEO;
        window.generateSEOTitle = generateSEOTitle;
        window.generateSEODescription = generateSEODescription;
        window.generateSEOKeywords = generateSEOKeywords;
        window.toggleAdvancedSEO = toggleAdvancedSEO;
        window.copyImageCode = copyImageCode;
        window.removeImage = removeImage;
        // Export functions for global use
        window.showSection = showSection;
        window.logout = logout;
        window.editPost = editPost;
        window.viewPost = viewPost;
        window.toggleFeatured = toggleFeatured;
        window.updateFeaturedPost = updateFeaturedPost;
        window.duplicatePost = duplicatePost;
        window.deletePost = deletePost;
        window.cancelEdit = cancelEdit;
        window.changePassword = changePassword;
        window.exportData = exportData;
        window.importData = importData;
        window.copyImageCodeFixed = copyImageCodeFixed;
        window.insertImageAtCursorFixed = insertImageAtCursorFixed;
        window.removeImage = removeImage;
        window.setContentFormat = setContentFormat;
        window.refreshHTMLPreview = refreshHTMLPreview;
        window.handleFeaturedImageUpload = handleFeaturedImageUpload;
    </script>
</body>
</html>